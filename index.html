<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordträning: Svenska - Tyska</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --success: #3fb950;
            --error: #f85149;
            --hover: #1f6feb;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .screen {
            display: none;
            background: var(--bg-secondary);
            padding: 32px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .active {
            display: block;
        }

        h1 {
            color: var(--text-primary);
            margin: 0 0 24px 0;
            font-size: 28px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        input[type="text"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="file"] {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            margin-bottom: 20px;
            width: 100%;
        }

        input[type="file"]::file-selector-button {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 12px;
        }

        input[type="file"]::file-selector-button:hover {
            background: var(--hover);
        }

        button {
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            margin-right: 8px;
            margin-top: 8px;
        }

        button:hover {
            background: var(--hover);
        }

        button:active {
            transform: scale(0.98);
        }

        .word-display {
            font-size: 32px;
            text-align: center;
            margin: 32px 0;
            padding: 40px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: 500;
        }

        #progress {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th,
        td {
            padding: 12px;
            border: 1px solid var(--border);
            text-align: left;
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        td {
            background: var(--bg-primary);
        }

        td input {
            margin: 0;
        }

        td button {
            margin: 0;
            background: var(--error);
            padding: 6px 12px;
            font-size: 13px;
        }

        td button:hover {
            background: #da3633;
        }

        .feedback {
            padding: 16px;
            margin: 20px 0 0 0;
            border-radius: 6px;
            display: none;
            border-left: 4px solid;
        }

        .feedback.correct {
            background: rgba(63, 185, 80, 0.15);
            color: var(--success);
            border-left-color: var(--success);
        }

        .feedback.wrong {
            background: rgba(248, 81, 73, 0.15);
            color: var(--error);
            border-left-color: var(--error);
        }

        .result-correct {
            color: var(--success);
            font-weight: 600;
        }

        .result-wrong {
            color: var(--error);
            font-weight: 600;
        }

        #score {
            font-size: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        #quizScreen input {
            margin-bottom: 16px;
        }

        #quizScreen button {
            width: 100%;
            padding: 14px;
            font-size: 16px;
        }

        @media (max-width: 600px) {
            body {
                padding: 20px 12px;
            }

            .screen {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .word-display {
                font-size: 28px;
                padding: 30px 16px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 8px;
            }

            input[type="text"] {
                font-size: 16px;
            }

            button {
                font-size: 14px;
                padding: 12px 16px;
            }

            #quizScreen button {
                padding: 16px;
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
    <div id="inputScreen" class="screen active">
        <h1>Ordträning: Svenska - Tyska</h1>
        <input type="file" id="csvFile" accept=".csv">
        <table id="wordTable">
            <tr>
                <th>Svenska</th>
                <th>Tyska</th>
                <th></th>
            </tr>
            <tr>
                <td><input type="text" class="sv"></td>
                <td><input type="text" class="de"></td>
                <td><button onclick="this.parentElement.parentElement.remove()">Ta bort</button></td>
            </tr>
        </table>
        <button onclick="addRow()">Lägg till rad</button>
        <button onclick="startPractice()">Börja träna</button>
    </div>

    <div id="quizScreen" class="screen">
        <h1>Träning</h1>
        <div id="progress"></div>
        <div id="swedishWord" class="word-display"></div>
        <input type="text" id="answer" placeholder="Tysk översättning">
        <button onclick="checkAnswer()">Svara</button>
        <div id="feedback" class="feedback"></div>

    </div>

    <div id="resultScreen" class="screen">
        <h1>Resultat</h1>
        <div id="score"></div>
        <button id="retryBtn" onclick="retryWrong()">Öva på fel</button>
        <button id="showResultsBtn" onclick="showFinalResults()">Visa resultat</button>
    </div>

    <div id="finalScreen" class="screen">
        <h1>Slutresultat</h1>
        <table id="resultsTable">
            <tr>
                <th>Svenska</th>
                <th>Tyska</th>
                <th>Ditt svar</th>
                <th>Resultat</th>
            </tr>
        </table>
        <button onclick="location.reload()">Börja om</button>
    </div>

    <script>
        let words = [], currentIdx = 0, wrong = [], results = [], roundNumber = 1;

        function addRow() {
            const table = document.getElementById('wordTable');
            const newRow = table.insertRow(-1); // Insert at the end

            // Create cells
            const svCell = newRow.insertCell(0);
            const deCell = newRow.insertCell(1);
            const btnCell = newRow.insertCell(2);

            // Add input fields
            svCell.innerHTML = '<input class="sv">';
            deCell.innerHTML = '<input class="de">';
            btnCell.innerHTML = '<button onclick="this.parentElement.parentElement.remove()">Ta bort</button>';
        }


        document.getElementById('csvFile').onchange = e => {
            const reader = new FileReader();
            reader.onload = e => {
                const pairs = e.target.result.split(/\r?\n/)
                    .filter(line => line.trim())
                    .map(line => {
                        const [sv, de] = line.split(/[,;]/).map(x => x.trim());
                        return { sv, de };
                    });
                const table = document.getElementById('wordTable');
                table.innerHTML = '<tr><th>Svenska</th><th>Tyska</th><th></th></tr>';
                pairs.forEach(({ sv, de }) => {
                    table.innerHTML += `
                        <tr><td><input class="sv" value="${sv}"></td>
                        <td><input class="de" value="${de}"></td>
                        <td><button onclick="this.parentElement.parentElement.remove()">Ta bort</button></td></tr>`;
                });
            };
            reader.readAsText(e.target.files[0]);
        };

        function startPractice() {
            words = Array.from(document.getElementById('wordTable').rows)
                .slice(1)
                .map(row => ({
                    sv: row.cells[0].querySelector('input').value.trim(),
                    de: row.cells[1].querySelector('input').value.trim()
                }))
                .filter(pair => pair.sv && pair.de);
            if (!words.length) return alert('Skriv in några ord först!');

            startNewRound(words);
        }

        function startNewRound(wordList) {
            words = wordList;
            words.sort(() => Math.random() - 0.5);
            currentIdx = 0;
            wrong = [];  // Reset wrong array at start of new round
            showScreen('quizScreen');
            showWord();
        }


        function showWord() {
            document.getElementById('progress').textContent = `Ord ${currentIdx + 1} av ${words.length}`;
            document.getElementById('swedishWord').textContent = words[currentIdx].sv;
            document.getElementById('answer').value = '';
            document.getElementById('answer').disabled = false;  // Added this line
            const button = document.querySelector('#quizScreen button');
            button.textContent = 'Svara';
            button.onclick = checkAnswer; // Make sure this is set

            document.getElementById('feedback').style.display = 'none';
            document.getElementById('answer').focus();
        }

        function checkAnswer() {
            const answer = document.getElementById('answer').value.trim().toLowerCase();
            const correct = answer === words[currentIdx].de.toLowerCase();
            const feedback = document.getElementById('feedback');
            const answerButton = document.querySelector('#quizScreen button');

            feedback.className = `feedback ${correct ? 'correct' : 'wrong'}`;
            feedback.innerHTML = correct ?
                '<strong>Rätt!</strong>' :
                `<strong>Fel!</strong> Rätt svar är: ${words[currentIdx].de}`;
            feedback.style.display = 'block';

            // Let's add debug here
            console.log('Checking answer:', {
                roundNumber,
                currentWord: words[currentIdx],
                answer,
                correct,
                currentIdx
            });

            // Add current attempt to results
            results.push({
                sv: words[currentIdx].sv,
                de: words[currentIdx].de,
                answer,
                correct,
                round: roundNumber
            });

            // Only add to wrong array if incorrect
            if (!correct) {
                wrong.push(words[currentIdx]);
            }




            answerButton.textContent = 'Nästa ord';
            answerButton.onclick = nextWord;
            answerButton.focus();

            document.getElementById('answer').disabled = true;
        }



        function nextWord() {
            // console.log('nextWord called', { currentIdx, wordsLength: words.length });

            currentIdx++;
            // console.log('after increment', { currentIdx, wordsLength: words.length });

            if (currentIdx >= words.length) {
                console.log('showing results');
                showResults();
                return;
            }

            // console.log('continuing to next word');
            const button = document.querySelector('#quizScreen button');
            button.textContent = 'Svara';
            button.onclick = checkAnswer;
            document.getElementById('answer').disabled = false;
            showWord();
        }

        function showResults() {
            // Only look at words from THIS round
            const currentRoundResults = results.filter(r => r.round === roundNumber);
            //          console.log({roundNumber,allResults: results, currentRoundResults,wrong});
            const numcorrect = currentRoundResults.filter(r => r.correct).length;
            const total = currentRoundResults.length;

            document.getElementById('score').textContent =
                `Runda ${roundNumber}: Du fick ${numcorrect} rätt av ${total}!`;

            const retryBtn = document.getElementById('retryBtn');
            const showResultsBtn = document.getElementById('showResultsBtn');

            // Simply use the wrong array as it is
            retryBtn.style.display = wrong.length ? 'inline' : 'none';
            showResultsBtn.style.display = 'inline';

            retryBtn.textContent = `Öva på ${wrong.length} felaktiga ord`;
            showResultsBtn.textContent = 'Visa slutresultat';

            if (retryBtn.style.display === 'inline') {
                retryBtn.focus();
            } else {
                showResultsBtn.focus();
            }

            showScreen('resultScreen');
        }






        function retryWrong() {
            roundNumber++;
            // No need to map since we're now storing the actual words
            startNewRound(wrong);
        }


        function showFinalResults() {
            const table = document.getElementById('resultsTable');
            table.innerHTML = '<tr><th>Svenska</th><th>Tyska</th><th>Ditt svar</th><th>Resultat</th><th>Runda</th></tr>';
            results.forEach(r => {
                table.innerHTML += `
            <tr>
                <td>${r.sv}</td>
                <td>${r.de}</td>
                <td>${r.answer}</td>
                <td class="${r.correct ? 'result-correct' : 'result-wrong'}">
                    ${r.correct ? '✓' : '✗'}
                </td>
                <td>${r.round}</td>
            </tr>`;
            });
            showScreen('finalScreen');
        }


        // And let's also verify that showScreen is working
        function showScreen(id) {
            //  console.log('showScreen called', { id });
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        document.getElementById('answer').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                const button = document.querySelector('#quizScreen button');
                if (!e.target.disabled) {
                    if (button.textContent === 'Svara') {
                        checkAnswer();
                    } else {
                        nextWord();
                    }
                }
            }
        });
        document.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                // Only handle if we're on the result screen
                const resultScreen = document.querySelector('#resultScreen.active');
                if (resultScreen) {
                    // If "Öva på fel" is visible, click it
                    const retryBtn = document.getElementById('retryBtn');
                    if (retryBtn.style.display === 'inline') {
                        retryWrong();
                    }
                    // Otherwise click "Visa resultat"
                    else {
                        showFinalResults();
                    }
                }
            }
        });
    </script>
</body>

</html>